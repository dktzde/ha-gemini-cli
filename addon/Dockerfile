# Build context: addon/ directory
# HA Supervisor uses the config.yaml directory as build context.

# Global ARG â€” must be before any FROM to be visible across stages
ARG BUILD_FROM=ghcr.io/hassio-addons/base:20.0.1

# Stage 1: Build MCP server and pre-index docs
# Use same Alpine version as the HA base image so native modules (better-sqlite3)
# compile against the same Node.js version and musl libc.
FROM alpine:3.23 AS mcp-builder

RUN apk add --no-cache nodejs npm git build-base python3 && \
    npm install -g pnpm

WORKDIR /build

# Clone docs from the repository (same repo, just need the docs/ directory)
# Using original repo for docs since local repo might not be pushed
ARG DOCS_REPO=https://github.com/dkmaker/hass-claude-code.git
ARG DOCS_REF=main
RUN git clone --depth 1 --branch "${DOCS_REF}" "${DOCS_REPO}" /tmp/repo && \
    cp -r /tmp/repo/docs /build/docs && \
    rm -rf /tmp/repo

# Install MCP server dependencies
COPY mcp-server/package.json mcp-server/pnpm-lock.yaml* ./mcp-server/
RUN cd mcp-server && pnpm install --frozen-lockfile 2>/dev/null || pnpm install

# Copy MCP server source
COPY mcp-server/ ./mcp-server/

# Build keyword-only index (needs tsx for TypeScript source)
RUN cd mcp-server && \
    DOCS_DB_PATH=/build/mcp-server/data/docs-search.db \
    DOCS_PATH=/build/docs \
    ENABLE_EMBEDDINGS=false \
    node --import tsx src/build-index.ts

# Compile TypeScript to JavaScript
RUN cd mcp-server && pnpm run build

# Prune dev dependencies (tsx, typescript, @types/*) from final output
RUN cd mcp-server && pnpm prune --prod

# Stage 2: Final add-on image
# hadolint ignore=DL3006
FROM ${BUILD_FROM}

SHELL ["/bin/bash", "-o", "pipefail", "-c"]

ENV TERM="xterm-256color"

# Install system packages
# hadolint ignore=DL3018
RUN apk add --no-cache \
    bash \
    ca-certificates \
    curl \
    git \
    libgcc \
    libstdc++ \
    nodejs \
    npm \
    ripgrep \
    tmux \
    ttyd

# Install Gemini CLI via npm
RUN npm install -g @google/gemini-cli

# Disable auto-updater for Gemini CLI if applicable (generic env var)
ENV DISABLE_AUTOUPDATER=1

# Copy MCP server from builder (compiled JS + prod deps + pre-built DB)
COPY --from=mcp-builder /build/mcp-server/dist /opt/mcp-server/dist
COPY --from=mcp-builder /build/mcp-server/node_modules /opt/mcp-server/node_modules
COPY --from=mcp-builder /build/mcp-server/data /opt/mcp-server/data
COPY --from=mcp-builder /build/mcp-server/package.json /opt/mcp-server/package.json

# Copy docs
COPY --from=mcp-builder /build/docs /opt/docs

# Copy rootfs overlay
COPY rootfs /

# Ensure scripts are executable
RUN chmod a+x /usr/bin/gemini-entrypoint.sh \
    && find /etc/s6-overlay/s6-rc.d -name 'run' -exec chmod a+x {} \; \
    && find /etc/s6-overlay/s6-rc.d -name 'finish' -exec chmod a+x {} \;

# Build arguments for labels
ARG BUILD_ARCH
ARG BUILD_DATE
ARG BUILD_DESCRIPTION
ARG BUILD_NAME
ARG BUILD_REF
ARG BUILD_REPOSITORY
ARG BUILD_VERSION

# Labels
LABEL \
    io.hass.name="${BUILD_NAME}" \
    io.hass.description="${BUILD_DESCRIPTION}" \
    io.hass.arch="${BUILD_ARCH}" \
    io.hass.type="addon" \
    io.hass.version=${BUILD_VERSION}
