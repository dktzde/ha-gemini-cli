#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Claude Code Add-on: ttyd web terminal
# Runs ttyd → tmux → claude-entrypoint.sh
# ==============================================================================
declare -a options
declare ingress_port

bashio::log.info 'Starting the ttyd daemon...'

# Set daemon debug level
if bashio::debug; then
    options+=(-d7)
else
    options+=(-d1)
fi

# Listen on all interfaces (Supervisor Ingress proxies to this container)
options+=(-i 0.0.0.0)

# Enable terminal input
options+=(--writable)

# Get assigned Ingress port
ingress_port=$(bashio::addon.ingress_port)
options+=(-p "${ingress_port}")

# Run ttyd as claude user (non-root required for yolo mode)
exec ttyd "${options[@]}" \
    su -l claude -c "cd /homeassistant 2>/dev/null || cd /home/claude; tmux -u new -A -s claude /usr/bin/claude-entrypoint.sh"
