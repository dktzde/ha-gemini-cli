#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Claude Code Add-on: Environment setup
# Sets up API key, CLAUDE.md, .mcp.json, persistent storage
# Runs as root (s6 oneshot), sets up claude user environment
# ==============================================================================
declare api_key
declare model
declare yolo_mode
declare enable_embeddings

bashio::log.info 'Setting up Claude Code environment...'

# --- Read config ---
api_key=$(bashio::config 'api_key')
model=$(bashio::config 'model')
yolo_mode=$(bashio::config 'yolo_mode')
enable_embeddings=$(bashio::config 'enable_embeddings')

# --- Set environment variables for all services (s6 convention: one file per var) ---
printf '%s' "${enable_embeddings}" > /var/run/s6/container_environment/ENABLE_EMBEDDINGS
printf '%s' "/opt/mcp-server/data/docs-search.db" > /var/run/s6/container_environment/DOCS_DB_PATH
printf '%s' "/opt/docs" > /var/run/s6/container_environment/DOCS_PATH
printf '%s' "/data/models" > /var/run/s6/container_environment/MODELS_DIR

# Write all config to /etc/profile.d/ so the entrypoint shell sees them
{
    if bashio::var.has_value "${api_key}"; then
        echo "export ANTHROPIC_API_KEY=\"${api_key}\""
    else
        bashio::log.info 'No API key configured â€” use /login in Claude Code to authenticate via subscription.'
    fi
    echo "export SUPERVISOR_TOKEN=\"${SUPERVISOR_TOKEN}\""
    echo "export DISABLE_AUTOUPDATER=1"
    echo "export CLAUDE_MODEL=\"${model}\""
    echo "export CLAUDE_YOLO=\"${yolo_mode}\""
    echo "export HOME=/home/claude"
} > /etc/profile.d/claude.sh

# --- Persistent storage (owned by claude user) ---
mkdir -p /data/.claude /data/models
if [[ ! -f /data/.claude.json ]]; then
    echo '{}' > /data/.claude.json
fi
touch /data/.bash_history

# Symlink persistent data into claude user home
ln -sf /data/.claude /home/claude/.claude
ln -sf /data/.claude.json /home/claude/.claude.json
ln -sf /data/.bash_history /home/claude/.bash_history

# Symlink convenient paths into claude home
ln -sf /homeassistant /home/claude/homeassistant
ln -sf /share /home/claude/share

# --- Set permissions for claude user ---
# Own the persistent data
chown -R claude:claude /data/.claude /data/.claude.json /data/.bash_history /data/models
# Own the home directory
chown -R claude:claude /home/claude
# Write access to HA config, addon config, and share
chown -R claude:claude /homeassistant /config /share 2>/dev/null || true

# --- Generate managed MCP config (system-wide, always loaded) ---
bashio::log.info 'Generating MCP server configuration...'

mkdir -p /etc/claude-code

cat > /etc/claude-code/managed-mcp.json << MCPEOF
{
  "mcpServers": {
    "home-assistant": {
      "command": "node",
      "args": ["/opt/mcp-server/dist/index.js"],
      "env": {
        "SUPERVISOR_TOKEN": "${SUPERVISOR_TOKEN}",
        "ENABLE_EMBEDDINGS": "${enable_embeddings}",
        "DOCS_DB_PATH": "/opt/mcp-server/data/docs-search.db",
        "DOCS_PATH": "/opt/docs",
        "MODELS_DIR": "/data/models"
      }
    }
  }
}
MCPEOF

# --- Generate default CLAUDE.md in /homeassistant/ if absent ---
if [[ ! -f /homeassistant/CLAUDE.md ]]; then
    bashio::log.info 'Creating default CLAUDE.md in Home Assistant config...'
    cat > /homeassistant/CLAUDE.md << 'EOF'
# Home Assistant Development Environment

You are working inside a Home Assistant instance with full API access.

## Available MCP Tools

The `home-assistant` MCP server provides these tools:
- `search_entities` - Search entities by name, domain, or area
- `get_entity_state` - Get state and attributes of an entity
- `call_service` - Call any HA service (turn on lights, trigger automations, etc.)
- `search_automations` - Search automation entities
- `get_ha_config` - Get HA core configuration
- `list_areas` - List all defined areas
- `search_devices` - Search device registry
- `get_config_entries` - List integration config entries
- `search_docs` - Search HA developer and user documentation
- `read_doc` - Read a specific documentation file
- `get_doc_stats` - Get documentation index statistics

## File Locations

- `/homeassistant/` - Home Assistant configuration directory
- `/homeassistant/.storage/` - Internal registry and state data
- `/share/` - Shared storage between add-ons
- `/ssl/` - SSL certificates (read-only)
- `/media/` - Media files (read-only)
EOF
fi

bashio::log.info 'Claude Code environment ready.'
